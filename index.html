<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPENMAT PRO Timer</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brandRed: '#FF2400',
                        brandBlue: '#00F3FF',
                        bjjGreen: '#00e650',
                        bjjYellow: '#ffd700',
                        bgDark: '#050505',
                        panel: 'rgba(15, 15, 15, 0.85)'
                    },
                    fontFamily: {
                        oxanium: ['Oxanium', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* Mantenemos solo el CSS estrictamente necesario para animaciones SVG */
        :root { --stroke-width: 6; }
        
        body { transition: background-color 0.5s; }

        .progress-ring { transform: rotate(-90deg); transform-origin: 50% 50%; width: 100%; height: 100%; overflow: visible; }
        .progress-ring__circle-track { stroke: rgba(50, 50, 50, 0.5); stroke-width: var(--stroke-width); fill: transparent; }
        .progress-ring__circle {
            stroke: #FF2400; stroke-width: var(--stroke-width); stroke-linecap: round; fill: transparent;
            stroke-dasharray: 283; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear, stroke 0.3s ease;
            filter: drop-shadow(0 0 15px #FF2400);
        }

        /* Modos Visuales y Animaciones */
        body.mode-rest .progress-ring__circle { stroke: #00F3FF; filter: drop-shadow(0 0 20px #00F3FF); }
        body.mode-rest #time-display { color: #00F3FF; text-shadow: 0 0 30px rgba(0, 243, 255, 0.6); }
        body.mode-rest .btn-mode.active { background-color: #00F3FF; border-color: #00F3FF; color: black; box-shadow: 0 0 20px #00F3FF; }

        @keyframes pulse-red { 0% { filter: drop-shadow(0 0 15px #FF2400); } 50% { filter: drop-shadow(0 0 40px #FF2400); } 100% { filter: drop-shadow(0 0 15px #FF2400); } }
        @keyframes pulse-blue { 0% { filter: drop-shadow(0 0 15px #00F3FF); } 50% { filter: drop-shadow(0 0 40px #00F3FF); } 100% { filter: drop-shadow(0 0 15px #00F3FF); } }
        body.pulse-red .progress-ring__circle { animation: pulse-red 1s infinite; }
        body.pulse-blue .progress-ring__circle { animation: pulse-blue 1s infinite; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    </style>
</head>

<body class="bg-bgDark text-white font-oxanium min-h-screen flex flex-col justify-between items-center p-2 lg:p-6 overflow-x-hidden mode-work" style="background-image: url('tv_bg.svg'); background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed;">

    <header class="w-full flex justify-center mb-2 lg:mb-4 flex-shrink-0 z-10">
        <img src="OPENMAT LOGO BLANCO.png" alt="OPENMAT" class="h-12 lg:h-20 drop-shadow-[0_0_8px_rgba(0,0,0,0.8)]" onerror="this.style.display='none'; document.querySelector('header').innerText='OPENMAT'">
    </header>

    <main class="w-full flex-grow flex flex-col lg:flex-row items-center justify-center relative gap-6 z-50">
        
        <div class="relative flex items-center justify-center w-[60vmin] h-[60vmin] lg:w-[45vmin] lg:h-[45vmin] max-w-[500px] max-h-[500px]">
            <svg class="progress-ring absolute inset-0" viewBox="0 0 100 100">
                <circle class="progress-ring__circle-track" cx="50" cy="50" r="45" />
                <circle class="progress-ring__circle" cx="50" cy="50" r="45" />
            </svg>
            <div class="absolute flex flex-col items-center justify-center text-center">
                <div id="status-label" class="text-[3.5vmin] lg:text-[2.5vmin] uppercase font-extrabold tracking-widest text-gray-400 drop-shadow-md mb-[-1vmin]">LISTO</div>
                <div id="time-display" class="text-[16vmin] lg:text-[12vmin] font-extrabold leading-none text-brandRed drop-shadow-[0_0_30px_rgba(255,36,0,0.6)] transition-all tabular-nums">00:00</div>
                <div id="round-display" class="text-[3.5vmin] lg:text-[2.5vmin] font-bold text-gray-400 tracking-wider drop-shadow-md mt-1">RND 1</div>
            </div>
        </div>

        <div id="score-panel" class="w-full lg:w-auto flex flex-row lg:flex-col justify-center gap-2 lg:gap-4 lg:absolute lg:right-4 lg:top-1/2 lg:-translate-y-1/2 z-50">
            
            <div class="bg-panel backdrop-blur-sm rounded-lg border-l-4 border-bjjGreen p-2 lg:p-4 w-1/2 lg:w-[220px] shadow-[0_0_15px_rgba(0,0,0,0.6)]">
                <div class="text-bjjGreen font-extrabold text-center text-sm lg:text-lg tracking-wider">VERDE</div>
                <div id="g-p" class="text-bjjGreen text-5xl lg:text-7xl font-extrabold text-center my-1 drop-shadow-[0_0_15px_rgba(0,230,80,0.4)] leading-none">0</div>
                <div class="flex justify-around text-xs lg:text-sm font-bold text-gray-400 mb-2">
                    <div>A: <span id="g-a" class="text-white">0</span></div>
                    <div>P: <span id="g-pe" class="text-white">0</span></div>
                </div>
                <div class="grid grid-cols-3 gap-1">
                    <button onclick="updScore('g','p',2)" class="bg-[#222] hover:bg-[#444] text-white font-extrabold text-xs lg:text-sm py-2 rounded focus:ring-2 focus:ring-bjjGreen transition">+2</button>
                    <button onclick="updScore('g','p',3)" class="bg-[#222] hover:bg-[#444] text-white font-extrabold text-xs lg:text-sm py-2 rounded focus:ring-2 focus:ring-bjjGreen transition">+3</button>
                    <button onclick="updScore('g','p',4)" class="bg-[#222] hover:bg-[#444] text-white font-extrabold text-xs lg:text-sm py-2 rounded focus:ring-2 focus:ring-bjjGreen transition">+4</button>
                    <button onclick="updScore('g','a',1)" class="bg-[#222] hover:bg-[#444] text-white font-extrabold text-xs lg:text-sm py-2 rounded focus:ring-2 focus:ring-bjjGreen transition">+A</button>
                    <button onclick="updScore('g','pe',1)" class="bg-[#222] hover:bg-[#444] text-white font-extrabold text-xs lg:text-sm py-2 rounded focus:ring-2 focus:ring-bjjGreen transition">+P</button>
                    <button onclick="updScore('g','p',-1)" class="bg-[#111] hover:bg-red-900 text-gray-500 font-extrabold text-xs lg:text-sm py-2 rounded focus:ring-2 focus:ring-gray-500 transition">-1</button>
                </div>
            </div>

            <div class="bg-panel backdrop-blur-sm rounded-lg border-l-4 border-bjjYellow p-2 lg:p-4 w-1/2 lg:w-[220px] shadow-[0_0_15px_rgba(0,0,0,0.6)]">
                <div class="text-bjjYellow font-extrabold text-center text-sm lg:text-lg tracking-wider">AMARILLO</div>
                <div id="y-p" class="text-bjjYellow text-5xl lg:text-7xl font-extrabold text-center my-1 drop-shadow-[0_0_15px_rgba(255,215,0,0.4)] leading-none">0</div>
                <div class="flex justify-around text-xs lg:text-sm font-bold text-gray-400 mb-2">
                    <div>A: <span id="y-a" class="text-white">0</span></div>
                    <div>P: <span id="y-pe" class="text-white">0</span></div>
                </div>
                <div class="grid grid-cols-3 gap-1">
                    <button onclick="updScore('y','p',2)" class="bg-[#222] hover:bg-[#444] text-white font-extrabold text-xs lg:text-sm py-2 rounded focus:ring-2 focus:ring-bjjYellow transition">+2</button>
                    <button onclick="updScore('y','p',3)" class="bg-[#222] hover:bg-[#444] text-white font-extrabold text-xs lg:text-sm py-2 rounded focus:ring-2 focus:ring-bjjYellow transition">+3</button>
                    <button onclick="updScore('y','p',4)" class="bg-[#222] hover:bg-[#444] text-white font-extrabold text-xs lg:text-sm py-2 rounded focus:ring-2 focus:ring-bjjYellow transition">+4</button>
                    <button onclick="updScore('y','a',1)" class="bg-[#222] hover:bg-[#444] text-white font-extrabold text-xs lg:text-sm py-2 rounded focus:ring-2 focus:ring-bjjYellow transition">+A</button>
                    <button onclick="updScore('y','pe',1)" class="bg-[#222] hover:bg-[#444] text-white font-extrabold text-xs lg:text-sm py-2 rounded focus:ring-2 focus:ring-bjjYellow transition">+P</button>
                    <button onclick="updScore('y','p',-1)" class="bg-[#111] hover:bg-red-900 text-gray-500 font-extrabold text-xs lg:text-sm py-2 rounded focus:ring-2 focus:ring-gray-500 transition">-1</button>
                </div>
            </div>

        </div>
    </main>

    <footer class="w-full max-w-5xl flex flex-col gap-3 items-center mt-4 z-0 flex-shrink-0">
        
        <div class="flex flex-wrap justify-center gap-2 w-full">
            <button class="btn-mode active bg-panel border border-gray-600 hover:bg-gray-800 text-white font-bold py-2 px-3 lg:px-4 rounded uppercase text-sm lg:text-base focus:ring-2 focus:ring-white transition [&.active]:bg-brandRed [&.active]:text-black [&.active]:border-brandRed [&.active]:shadow-[0_0_15px_#FF2400]" onclick="setMode('bjj4', this)">4M</button>
            <button class="btn-mode bg-panel border border-gray-600 hover:bg-gray-800 text-white font-bold py-2 px-3 lg:px-4 rounded uppercase text-sm lg:text-base focus:ring-2 focus:ring-white transition [&.active]:bg-brandRed [&.active]:text-black [&.active]:border-brandRed [&.active]:shadow-[0_0_15px_#FF2400]" onclick="setMode('bjj5', this)">5M</button>
            <button class="btn-mode bg-panel border border-gray-600 hover:bg-gray-800 text-white font-bold py-2 px-3 lg:px-4 rounded uppercase text-sm lg:text-base focus:ring-2 focus:ring-white transition [&.active]:bg-brandRed [&.active]:text-black [&.active]:border-brandRed [&.active]:shadow-[0_0_15px_#FF2400]" onclick="setMode('bjj6', this)">6M</button>
            <button class="btn-mode bg-panel border border-gray-600 hover:bg-gray-800 text-white font-bold py-2 px-3 lg:px-4 rounded uppercase text-sm lg:text-base focus:ring-2 focus:ring-white transition [&.active]:bg-brandRed [&.active]:text-black [&.active]:border-brandRed [&.active]:shadow-[0_0_15px_#FF2400]" onclick="setMode('bjj10', this)">10M</button>
            <button class="btn-mode bg-panel border border-gray-600 hover:bg-gray-800 text-white font-bold py-2 px-3 lg:px-4 rounded uppercase text-sm lg:text-base focus:ring-2 focus:ring-white transition [&.active]:bg-brandRed [&.active]:text-black [&.active]:border-brandRed [&.active]:shadow-[0_0_15px_#FF2400]" onclick="setMode('box45', this)">B45</button>
            <button class="btn-mode bg-panel border border-gray-600 hover:bg-gray-800 text-white font-bold py-2 px-3 lg:px-4 rounded uppercase text-sm lg:text-base focus:ring-2 focus:ring-white transition [&.active]:bg-brandRed [&.active]:text-black [&.active]:border-brandRed [&.active]:shadow-[0_0_15px_#FF2400]" onclick="setMode('box60', this)">B60</button>
            <button class="btn-mode bg-panel border border-gray-600 hover:bg-gray-800 text-white font-bold py-2 px-3 lg:px-4 rounded uppercase text-lg focus:ring-2 focus:ring-white transition [&.active]:bg-brandRed [&.active]:text-black [&.active]:border-brandRed [&.active]:shadow-[0_0_15px_#FF2400]" onclick="setMode('custom', this)">⚙️</button>
        </div>

        <div id="custom-panel" class="hidden flex-wrap justify-center gap-2 w-full">
            <div class="flex items-center bg-gray-900/90 border border-gray-700 p-2 rounded gap-2">
                <span class="text-brandRed font-extrabold text-sm">LUCHA</span>
                <button class="bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded font-bold" onclick="adjCustom('work', -15)">-</button>
                <span id="c-work-disp" class="font-extrabold w-12 text-center text-sm">05:00</span>
                <button class="bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded font-bold" onclick="adjCustom('work', 15)">+</button>
            </div>
            <div class="flex items-center bg-gray-900/90 border border-gray-700 p-2 rounded gap-2">
                <span class="text-brandBlue font-extrabold text-sm">DESC</span>
                <button class="bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded font-bold" onclick="adjCustom('rest', -5)">-</button>
                <span id="c-rest-disp" class="font-extrabold w-12 text-center text-sm">00:20</span>
                <button class="bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded font-bold" onclick="adjCustom('rest', 5)">+</button>
            </div>
        </div>

        <div class="flex flex-wrap justify-center gap-2 w-full">
            <div class="flex items-center bg-gray-900/90 border border-gray-700 p-2 rounded gap-2">
                <span class="font-extrabold text-sm text-gray-400">RNDS</span>
                <button class="bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded font-bold" onclick="changeRounds(-1)">-</button>
                <span id="max-rounds-display" class="font-extrabold w-6 text-center text-sm">10</span>
                <button class="bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded font-bold" onclick="changeRounds(1)">+</button>
            </div>
            <button id="btn-start" class="bg-gray-200 hover:bg-white text-black font-extrabold py-2 px-6 rounded uppercase focus:ring-4 focus:ring-yellow-400 transition min-w-[120px]" onclick="toggleTimer()">START</button>
            <button class="bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white font-extrabold py-2 px-6 rounded uppercase transition min-w-[100px]" onclick="resetTimer()">RESET</button>
        </div>

    </footer>

    <script>
        // --- LÓGICA DE AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep(freq = 800, duration = 200, type = 'square', vol = 1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.frequency.value = freq;
            osc.type = type;
            gainNode.gain.value = vol;
            osc.start();
            setTimeout(() => osc.stop(), duration);
        }
        const sndStart = () => { beep(800, 100); setTimeout(()=>beep(1200, 400), 100); };
        const sndRest = () => { beep(600, 100); setTimeout(()=>beep(400, 400), 100); };
        const sndCount = () => beep(800, 100, 'sine', 0.5);
        const sndEnd = () => { beep(800, 150); setTimeout(()=>beep(800, 150), 200); setTimeout(()=>beep(800, 400), 400); };

        // --- SISTEMA DE PUNTUACIÓN ---
        let matchScore = { g: { p: 0, a: 0, pe: 0 }, y: { p: 0, a: 0, pe: 0 } };

        function updScore(fighter, type, val) {
            matchScore[fighter][type] += val;
            if(matchScore[fighter][type] < 0) matchScore[fighter][type] = 0;
            document.getElementById(`${fighter}-${type}`).innerText = matchScore[fighter][type];
        }

        function resetScores() {
            matchScore = { g: { p: 0, a: 0, pe: 0 }, y: { p: 0, a: 0, pe: 0 } };
            ['g','y'].forEach(f => {
                ['p','a','pe'].forEach(t => { document.getElementById(`${f}-${t}`).innerText = '0'; });
            });
        }

        // --- LÓGICA DEL TIMER ---
        const circle = document.querySelector('.progress-ring__circle');
        const radius = circle.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        circle.style.strokeDasharray = `${circumference} ${circumference}`;
        circle.style.strokeDashoffset = 0;

        let timerInterval, timeLeft = 0, totalTime = 0, currentMode = 'bjj5', state = 'stopped', round = 1, maxRoundsLimit = 10;
        
        const modes = {
            'bjj4': { work: 240, rest: 20 }, 'bjj5': { work: 300, rest: 20 }, 'bjj6': { work: 360, rest: 20 },
            'bjj10': { work: 600, rest: 20 }, 'box45': { work: 45, rest: 15 }, 'box60': { work: 60, rest: 15 },
            'custom': { work: 300, rest: 20 }
        };

        const els = {
            time: document.getElementById('time-display'), status: document.getElementById('status-label'),
            round: document.getElementById('round-display'), btnStart: document.getElementById('btn-start'),
            maxRoundsDisplay: document.getElementById('max-rounds-display'), customPanel: document.getElementById('custom-panel'),
            cWorkDisp: document.getElementById('c-work-disp'), cRestDisp: document.getElementById('c-rest-disp'), body: document.body
        };

        function setProgress(percent) { circle.style.strokeDashoffset = circumference - (percent / 100) * circumference; }
        function formatTime(s) { const m = Math.floor(s / 60); const sec = s % 60; return `${m < 10 ? '0' : ''}${m}:${sec < 10 ? '0' : ''}${sec}`; }

        function setMode(modeName, btnElement) {
            currentMode = modeName;
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            
            if(modeName === 'custom') {
                els.customPanel.classList.remove('hidden');
                els.customPanel.classList.add('flex');
            } else {
                els.customPanel.classList.add('hidden');
                els.customPanel.classList.remove('flex');
            }
            resetTimer();
        }

        function changeRounds(delta) {
            maxRoundsLimit = Math.max(1, Math.min(99, maxRoundsLimit + delta));
            els.maxRoundsDisplay.innerText = maxRoundsLimit;
        }

        function adjCustom(type, delta) {
            if(type === 'work') {
                modes['custom'].work = Math.max(15, modes['custom'].work + delta);
                els.cWorkDisp.innerText = formatTime(modes['custom'].work);
            } else {
                modes['custom'].rest = Math.max(0, modes['custom'].rest + delta);
                els.cRestDisp.innerText = formatTime(modes['custom'].rest);
            }
            if(currentMode === 'custom') resetTimer();
        }

        function resetTimer() {
            clearInterval(timerInterval);
            state = 'stopped'; round = 1; timeLeft = totalTime = modes[currentMode].work;
            
            els.time.innerText = formatTime(timeLeft);
            els.status.innerText = "LISTO"; els.status.style.color = "#888";
            els.round.innerText = "RND 1";
            els.btnStart.innerText = "START"; els.btnStart.className = "bg-gray-200 hover:bg-white text-black font-extrabold py-2 px-6 rounded uppercase transition min-w-[120px]";
            
            setProgress(100);
            els.body.className = "bg-bgDark text-white font-oxanium min-h-screen flex flex-col justify-between items-center p-2 lg:p-6 overflow-x-hidden mode-work";
            resetScores();
        }

        function toggleTimer() { state === 'stopped' || state === 'paused' ? startTimer() : pauseTimer(); }

        function startTimer() {
            if (state === 'finished') { resetTimer(); return; }
            if (state === 'stopped') { state = 'work'; els.status.innerText = "LUCHA"; sndStart(); } 
            else if (state === 'paused') { state = els.body.classList.contains('mode-rest') ? 'rest' : 'work'; }

            els.btnStart.innerText = "PAUSA";
            els.btnStart.className = "bg-yellow-400 hover:bg-yellow-300 text-black font-extrabold py-2 px-6 rounded uppercase shadow-[0_0_20px_#facc15] transition min-w-[120px]";

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                els.time.innerText = formatTime(timeLeft);
                setProgress((timeLeft / totalTime) * 100);

                if (timeLeft <= 10 && timeLeft > 0) els.body.classList.add(state === 'work' ? 'pulse-red' : 'pulse-blue');
                if (timeLeft <= 3 && timeLeft > 0) sndCount();
                if (timeLeft === 0) switchPhase();
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(timerInterval);
            state = 'paused';
            els.btnStart.innerText = "RESUME";
            els.btnStart.className = "bg-gray-200 hover:bg-white text-black font-extrabold py-2 px-6 rounded uppercase transition min-w-[120px]";
            els.body.classList.remove('pulse-red', 'pulse-blue');
        }

        function switchPhase() {
            clearInterval(timerInterval);
            els.body.classList.remove('pulse-red', 'pulse-blue');

            if (state === 'work') {
                if (round >= maxRoundsLimit) return finishSession();
                if(modes[currentMode].rest > 0) {
                    state = 'rest'; timeLeft = totalTime = modes[currentMode].rest;
                    els.status.innerText = "DESCANSO";
                    els.body.className = "bg-bgDark text-white font-oxanium min-h-screen flex flex-col justify-between items-center p-2 lg:p-6 overflow-x-hidden mode-rest";
                    sndRest(); setProgress(100); startTimer();
                } else startNextRound();
            } else startNextRound();
        }

        function startNextRound() {
            state = 'work'; round++; els.round.innerText = "RND " + round;
            timeLeft = totalTime = modes[currentMode].work;
            els.status.innerText = "LUCHA";
            els.body.className = "bg-bgDark text-white font-oxanium min-h-screen flex flex-col justify-between items-center p-2 lg:p-6 overflow-x-hidden mode-work";
            sndStart(); setProgress(100); startTimer();
        }

        function finishSession() {
            state = 'finished'; els.status.innerText = "TERMINADO"; els.status.style.color = "#fff";
            els.time.innerText = "OSS";
            els.btnStart.innerText = "REINICIAR"; els.btnStart.className = "bg-gray-200 hover:bg-white text-black font-extrabold py-2 px-6 rounded uppercase transition min-w-[120px]";
            setProgress(0); sndEnd();
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(() => {}); });
        }

        resetTimer();
    </script>
</body>
</html>